#!/usr/bin/env bash

# Check if we're root and re-execute if we're not.
rootcheck() {
  if [ $(id -u) != "0" ]; then
    sudo "$0" "$@"
    exit $?
  fi
}

rootcheck "${@}"

./${STOP_SCRIPT}

if [ -f "${SYSTEMD_DESTINATION_PATH}/${SYSTEMD_SCRIPT}" ]; then
  rm -f ${SYSTEMD_DESTINATION_PATH}/${SYSTEMD_SCRIPT}
  systemctl daemon-reload
fi

GREENGRASS_REGION_FILE="/greengrass/config/region.txt"

clean_aws_credential_process() {
  # Get the user from the first parameter
  USER=$1

  REGION=$(cat $GREENGRASS_REGION_FILE)

  TEMP=$(aws configure get --profile default region)

  if [ -n "$TEMP" ]; then
    # A default profile exists, did we create it?
    TEMP=$(aws configure get --profile default configured_by_ggp)

    if [ -n "$TEMP" ]; then
      # We created it, use the default profile
      PROFILE="default"
    else
      # We didn't create it, use the greengrass profile
      PROFILE="greengrass"
    fi
  else
    # No default profile exists, use it
    PROFILE="default"
  fi

  if [ $USER != "root" ]; then
    RUN_USER_PREFIX="runuser -l ${SUDO_USER} -c \""
    RUN_USER_SUFFIX="\""
  else
    RUN_USER_PREFIX=""
    RUN_USER_SUFFIX=""
  fi

  CMD="$RUN_USER_PREFIX aws configure set --profile $PROFILE credential_process '' $RUN_USER_SUFFIX"
  eval $CMD
  CMD="$RUN_USER_PREFIX aws configure set --profile $PROFILE configured_by_ggp true $RUN_USER_SUFFIX"
  eval $CMD
}

clean_aws_credential_process "root"
clean_aws_credential_process "${SUDO_USER}"

rm -rf /greengrass \
  ./${START_SCRIPT} \
  ./${STOP_SCRIPT} \
  ./${MONITOR_SCRIPT} \
  ./${CLEAN_SCRIPT} \
  ./${INSTALL_SCRIPT} \
  ./${SYSTEMD_SCRIPT} \
  ./${CREDENTIALS_SCRIPT} \
  ./${GG_SH} \
  ./${GG_SH}.DEPLOYED \
  ./${GG_BITS} \
  ./ggds \
  ./ggd.*.tar \
  ./groupCA \
  ./ggd.*.device.key \
  ./ggd.*.device.crt \
  ./run-*.sh \
  ./config \
  ./certs \
  ./n \
  
